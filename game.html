<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BOLT999 - Color Prediction</title>

    <meta name="theme-color" content="#111827">
    <meta name="description" content="BOLT999 - Play Color Prediction and Mine games to win real money!">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="logo.avif">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="BOLT999">

    <link rel="icon" href="logo.avif" type="image/avif">

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

    <script>
        // Register service worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful');
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }

        // Handle PWA installation
        window.deferredPrompt = null;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            window.deferredPrompt = e;
            // Show install button or notification here if needed
        });
    </script>

    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js"></script>

    <style>
        body {
            font-family: 'Poppins', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background-color: #0a0a0a; /* Slightly off-black */
            background-image: radial-gradient(circle at top right, rgba(250, 204, 21, 0.15), transparent 50%),
                              radial-gradient(circle at bottom left, rgba(168, 85, 247, 0.15), transparent 60%);
            color: #e5e7eb; /* gray-200 */
        }

        .card-3d {
            background-color: rgba(20, 20, 20, 0.5); /* neutral-900 with opacity */
            backdrop-filter: blur(12px);
            border: 1px solid rgba(250, 204, 21, 0.1);
            border-radius: 1.5rem; /* 24px */
            box-shadow: 0px 8px 24px rgba(0,0,0,0.5), inset 0px 1px 1px rgba(255, 255, 255, 0.05);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card-3d:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0px 12px 32px rgba(250, 204, 21, 0.1), inset 0px 1px 1px rgba(255, 255, 255, 0.05);
        }

        .btn-3d {
             border-radius: 12px;
             border-bottom-width: 4px;
             transition: all 0.15s ease-in-out;
             text-shadow: 0px 1px 2px rgba(0,0,0,0.2);
             transform: perspective(1000px);
        }
        .btn-3d:hover {
            transform: translateY(-2px) perspective(1000px);
            border-bottom-width: 6px;
        }
        .btn-3d:active {
            transform: translateY(2px) perspective(1000px);
            border-bottom-width: 2px;
        }

        .btn-yellow {
             background: linear-gradient(145deg, #facc15, #eab308);
             border-color: #ca8a04;
             color: black;
        }
        .btn-green {
             background: linear-gradient(145deg, #22c55e, #16a34a);
             border-color: #15803d;
             color: white;
        }
        .btn-red {
             background: linear-gradient(145deg, #ef4444, #dc2626);
             border-color: #b91c1c;
             color: white;
        }
         .btn-purple {
             background: linear-gradient(145deg, #a855f7, #9333ea);
             border-color: #7e22ce;
             color: white;
        }


        /* Glassmorphism for inputs */
        .input-glass {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(5px);
            border-radius: 8px;
            color: white;
            transition: box-shadow 0.3s ease;
        }
        .input-glass::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }
        .input-glass:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(250, 204, 21, 0.5);
            background: rgba(255, 255, 255, 0.1);
        }
        
        @keyframes pulse-result {
            0% { transform: scale(0.8); opacity: 0.5; }
            50% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
        .animate-pulse-result {
            animation: pulse-result 0.5s ease-out forwards;
        }
        /* Adjusted animation for the rocket to give a more dynamic feel */
        @keyframes fly {
            0% { transform: translateX(-50%) translateY(50%) scale(1); opacity: 0.5; }
            25% { transform: translateX(0%) translateY(0%) scale(1.1); opacity: 0.7; }
            50% { transform: translateX(50%) translateY(-50%) scale(1.2); opacity: 1; }
            75% { transform: translateX(100%) translateY(-25%) scale(1.1); opacity: 0.7; }
            100% { transform: translateX(150%) translateY(0%) scale(1); opacity: 0.5; }
        }
        .animate-fly {
            animation: fly 2s ease-in-out infinite alternate; /* Looping animation */
        }
        /* Mines Game specific styles */
        .mines-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            width: 100%;
            max-width: 320px; /* Adjust grid size */
            margin: 0 auto;
        }
        .mine-box {
            width: 60px; /* Fixed size for boxes */
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            background-color: #374151; /* unopened - gray-700 */
            border: 2px solid #ca8a04; /* golden-700 */
            color: #fefce8; /* yellow-50 */
        }
        .mine-box:hover:not(.safe):not(.mine):not(.disabled-box) {
            transform: scale(1.05);
            background-color: #4b5563; /* gray-600 */
        }
        .mine-box.safe {
            background-color: #eab308; /* Golden for safe */
            color: black;
            border-color: #facc15;
        }
        .mine-box.mine {
            background-color: #1f2937; /* Dark gray for mine */
            color: white;
            border-color: #ef4444; /* red border for emphasis */
        }
        .mine-box.safe_revealed {
            background-color: #ca8a04; /* Darker Golden for revealed safe (unopened) */
            color: white;
            border-color: #eab308;
        }
        .mine-box.disabled-box {
            cursor: not-allowed;
            opacity: 0.7;
        }
        .mine-box img {
            width: 80%; /* Make images fit inside the box */
            height: 80%;
            object-fit: contain;
        }

        /* Aviator video background styling */
        .aviator-video-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover; /* Cover the entire container */
            z-index: 0; /* Behind other content */
            border-radius: 8px; /* Match container border-radius */
        }

        /* Loader styles */
        .loader-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loader-content {
            position: relative;
            width: 120px;
            height: 120px;
        }

        .loader-logo {
            width: 80px;
            height: 80px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border-radius: 50%;
            border: 4px solid #facc15; /* Golden border */
            overflow: hidden;
        }

        .loader-logo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .loader-ring {
            position: absolute;
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 4px solid transparent;
            border-top-color: #facc15; /* Golden */
            animation: spin 1s linear infinite;
        }

        .loader-ring::before,
        .loader-ring::after {
            content: '';
            position: absolute;
            border-radius: 50%;
            border: 4px solid transparent;
        }

        .loader-ring::before {
            top: 5px;
            left: 5px;
            right: 5px;
            bottom: 5px;
            border-top-color: #eab308; /* Darker Golden */
            animation: spin 2s linear infinite;
        }

        .loader-ring::after {
            top: 15px;
            left: 15px;
            right: 15px;
            bottom: 15px;
            border-top-color: #ca8a04; /* Even Darker Golden */
            animation: spin 3s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loader-glow {
            position: absolute;
            width: 140px;
            height: 140px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(250, 204, 21, 0.2) 0%, rgba(250, 204, 21, 0) 70%);
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0% { transform: scale(0.8); opacity: 0.5; }
            50% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(0.8); opacity: 0.5; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCCgh6ML89ORBDOR7r4x8s79JvPjhLBTI8",
            authDomain: "bolt999-30e86.firebaseapp.com",
            projectId: "bolt999-30e86",
            storageBucket: "bolt999-30e86.firebasestorage.app",
            messagingSenderId: "627494404028",
            appId: "1:627494404028:web:af21c8bb1907093c7735b9"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Inlined SVG for Lucide icons for minimal requests
        const ArrowLeft = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-arrow-left"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>);
        const Coins = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-coins"><circle cx="8" cy="8" r="6"/><path d="M18.7 10.7H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H9.3a2 2 0 0 1-2-2V13a2 2 0 0 1 2-2h1.3"/><path d="M10 16H8"/></svg>);
        const TrendingUp = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-trending-up"><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></svg>);
        const History = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucude-history"><path d="M12 8v4l3 3"/><path d="M17.8 6.2c.7 5.1-1.6 9.8-6.1 11.3a5.5 5.5 0 0 1-7.8-7.6 5.5 5.5 0 0 1 7.6-7.8l1.6 1.6"/></svg>);
        const Gamepad = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-gamepad"><path d="M6 12H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v6a2 2 0 0 1-2 2h-2"/><path d="M12 12v6a2 2 0 0 0 2 2h4a2 2 0 0 0 2-2v-6"/><path d="M12 12H8a2 2 0 0 0-2 2v4a2 2 0 0 0 2 2h4"/></svg>);
        const Rocket = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-rocket"><path d="M4.5 16.5c-1.5 1.26-2 5-2 5L2 22c0 0.5 0.5 1 1 1h.5c0 0-3-1.5-2.5-3.5C3.5 16.5 6 15 6 15l-1.5 1.5z"/><path d="M10 15h4l-1 6H9l1-6z"/><path d="M17.7 9.3l-1.3-1.3c-0.2-0.2-0.5-0.3-0.7-0.3c-0.3 0-0.5 0.1-0.7 0.3l-1.3 1.3c-0.4 0.4-0.4 1 0 1.4l1.3 1.3c0.2 0.2 0.5 0.3 0.7 0.3c0.3 0 0.5-0.1 0.7-0.3l1.3-1.3c0.4-0.4 0.4-1 0-1.4z"/><path d="M16 21v-4l-1.5-1.5"/><path d="M13 14V3l3 3l-3 3"/><path d="M15 12h5.5c.5 0 1 .5 1 1v.5c0 0-1.5 3-3.5 2.5S15 12 15 12z"/></svg>);
        const Bomb = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-bomb"><circle cx="12" cy="12" r="10"/><path d="m15.5 9.5-3 3-3-3"/><path d="m8.5 14.5 3-3 3 3"/></svg>);
        const Sparkles = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-sparkles"><path d="M12 20V10"/><path d="M19 12H5"/><path d="m12 21.5 3.5 2.5L12 17l-3.5 2.5z"/><path d="m22 2-2.5 2.5L17 2l2.5-2.5z"/><path d="m2 2 2.5 2.5L7 2l-2.5-2.5z"/></svg>);

        // Logo Component
        const Logo = ({ onClick }) => (
            <div 
                className="w-16 h-16 rounded-full overflow-hidden border-4 border-yellow-400 shadow-lg cursor-pointer hover:scale-105 transition-transform"
                onClick={onClick}
            >
                <img src="logo.avif" alt="Beast Earn Logo" className="w-full h-full object-cover" />
            </div>
        );

        // Guide Button Component
        const GuideButton = ({ audioFile }) => {
            const [audio] = React.useState(new Audio(audioFile));

            // Cleanup audio when component unmounts
            React.useEffect(() => {
                return () => {
                    audio.pause();
                    audio.currentTime = 0;
                };
            }, []);

            const playGuide = () => {
                audio.currentTime = 0; // Reset to start
                audio.play();
            };

            return (
                <button
                    onClick={playGuide}
                    className="px-3 py-1 bg-yellow-400 text-black rounded-lg font-bold hover:bg-yellow-500 transition-colors flex items-center gap-2"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M12 16v-4"/>
                        <path d="M12 8h.01"/>
                    </svg>
                    Guide
                </button>
            );
        };

        // --- Auth Components ---
        const LoginPage = ({ setAuthenticated, navigateToRegister }) => {
            const [error, setError] = React.useState('');
            const [emailOrPhone, setEmailOrPhone] = React.useState('');
            const [password, setPassword] = React.useState('');
            const [loading, setLoading] = React.useState(false);

            const handleLogin = async (e) => {
                e.preventDefault();
                setError('');
                setLoading(true);
                
                try {
                    // Check if input is email or phone
                    const isEmail = emailOrPhone.includes('@');
                    let result;
                    
                    if (isEmail) {
                        // Login with email
                        result = await auth.signInWithEmailAndPassword(emailOrPhone, password);
                    } else {
                        // For phone login, we'll use email format with phone number
                        // This is a workaround since Firebase requires email format
                        const phoneEmail = `${emailOrPhone}@phone.bolt999.com`;
                        result = await auth.signInWithEmailAndPassword(phoneEmail, password);
                    }
                    
                    setAuthenticated(true);
                } catch (error) {
                    setError(error.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="max-w-md mx-auto min-h-screen text-white flex flex-col items-center justify-center p-4">
                    <Logo />
                    <h1 className="text-5xl font-extrabold my-8 text-transparent bg-clip-text bg-gradient-to-r from-yellow-300 to-amber-500 drop-shadow-lg" style={{ WebkitTextStroke: '1px rgba(0,0,0,0.3)' }}>BOLT999</h1>
                    <div className="card-3d p-8 w-full max-w-sm">
                        <h2 className="text-3xl font-bold mb-6 text-center text-white">Login</h2>
                        {error && <p className="text-red-400 text-sm mb-4">{error}</p>}
                        <form onSubmit={handleLogin} className="space-y-4">
                            <div>
                                <input
                                    type="text"
                                    placeholder="Email or Phone Number"
                                    value={emailOrPhone}
                                    onChange={(e) => setEmailOrPhone(e.target.value)}
                                    className="w-full px-4 py-3 input-glass"
                                    required
                                />
                            </div>
                            <div>
                                <input
                                    type="password"
                                    placeholder="Password"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    className="w-full px-4 py-3 input-glass"
                                    required
                                />
                            </div>
                            <button
                                type="submit"
                                disabled={loading}
                                className="w-full btn-3d btn-yellow py-3 rounded-lg font-bold transition-all duration-300 shadow-lg hover:shadow-xl transform hover:-translate-y-1 disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                {loading ? 'Logging in...' : 'Login'}
                            </button>
                        </form>
                        <p className="text-center text-sm opacity-80 mt-4">
                            Don't have an account? <button onClick={navigateToRegister} className="text-yellow-300 font-semibold hover:underline">Register here</button>
                        </p>
                    </div>
                </div>
            );
        };

        const RegisterPage = ({ setAuthenticated, navigateToLogin }) => {
            const [error, setError] = React.useState('');
            const [emailOrPhone, setEmailOrPhone] = React.useState('');
            const [password, setPassword] = React.useState('');
            const [confirmPassword, setConfirmPassword] = React.useState('');
            const [loading, setLoading] = React.useState(false);

            const handleRegister = async (e) => {
                e.preventDefault();
                setError('');
                
                if (password !== confirmPassword) {
                    setError('Passwords do not match');
                    return;
                }
                
                if (password.length < 6) {
                    setError('Password must be at least 6 characters long');
                    return;
                }
                
                setLoading(true);
                
                try {
                    // Check if input is email or phone
                    const isEmail = emailOrPhone.includes('@');
                    let email = emailOrPhone;
                    
                    if (!isEmail) {
                        // For phone registration, create email format
                        // Validate phone number (basic validation)
                        if (!/^[0-9]{10}$/.test(emailOrPhone)) {
                            setError('Please enter a valid 10-digit phone number');
                            setLoading(false);
                            return;
                        }
                        email = `${emailOrPhone}@phone.bolt999.com`;
                    }
                    
                    // Create user with email and password
                    const result = await auth.createUserWithEmailAndPassword(email, password);
                    
                    // Create initial user document
                    await db.collection('users').doc(result.user.uid).set({
                        email: isEmail ? emailOrPhone : null,
                        phone: isEmail ? null : emailOrPhone,
                        balance: 0,
                        gameHistory: [],
                        depositHistory: [],
                        withdrawHistory: [],
                        createdAt: new Date().toISOString()
                    });
                    
                    setAuthenticated(true);
                } catch (error) {
                    setError(error.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="max-w-md mx-auto min-h-screen text-white flex flex-col items-center justify-center p-4">
                    <Logo />
                    <h1 className="text-5xl font-extrabold my-8 text-transparent bg-clip-text bg-gradient-to-r from-yellow-300 to-amber-500 drop-shadow-lg" style={{ WebkitTextStroke: '1px rgba(0,0,0,0.3)' }}>BOLT999</h1>
                    <div className="card-3d p-8 w-full max-w-sm">
                        <h2 className="text-3xl font-bold mb-6 text-center text-white">Register</h2>
                        {error && <p className="text-red-400 text-sm mb-4">{error}</p>}
                        <form onSubmit={handleRegister} className="space-y-4">
                            <div>
                                <input
                                    type="text"
                                    placeholder="Email or Phone Number"
                                    value={emailOrPhone}
                                    onChange={(e) => setEmailOrPhone(e.target.value)}
                                    className="w-full px-4 py-3 input-glass"
                                    required
                                />
                            </div>
                            <div>
                                <input
                                    type="password"
                                    placeholder="Password (min 6 characters)"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    className="w-full px-4 py-3 input-glass"
                                    required
                                    minLength="6"
                                />
                            </div>
                            <div>
                                <input
                                    type="password"
                                    placeholder="Confirm Password"
                                    value={confirmPassword}
                                    onChange={(e) => setConfirmPassword(e.target.value)}
                                    className="w-full px-4 py-3 input-glass"
                                    required
                                    minLength="6"
                                />
                            </div>
                            <button
                                type="submit"
                                disabled={loading}
                                className="w-full btn-3d btn-yellow py-3 rounded-lg font-bold transition-all duration-300 shadow-lg hover:shadow-xl transform hover:-translate-y-1 disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                {loading ? 'Creating Account...' : 'Register'}
                            </button>
                        </form>
                        <p className="text-center text-sm opacity-80 mt-4">
                            Already have an account? <button onClick={navigateToLogin} className="text-yellow-300 font-semibold hover:underline">Login here</button>
                        </p>
                    </div>
                </div>
            );
        };


        // --- History Page Component ---
        const HistoryPage = ({ navigateTo, gameHistory, depositHistory, withdrawHistory, initialTab = 'game' }) => {
            const [activeTab, setActiveTab] = React.useState(initialTab); // 'game', 'deposit', 'withdraw'

            React.useEffect(() => {
                setActiveTab(initialTab);
            }, [initialTab]);

            const getResultColor = (result) => {
                if (result === 0) return 'bg-gradient-to-r from-red-500 to-purple-500';
                if (result === 5) return 'bg-gradient-to-r from-yellow-500 to-purple-500';
                if (result % 2 === 0) return 'bg-red-500';
                return 'bg-yellow-500';
            };

            return (
                <div className="max-w-md mx-auto bg-gradient-to-b from-black to-gray-900 min-h-screen text-white p-4">
                    <div className="flex items-center gap-2 mb-6">
                        <button onClick={() => navigateTo('gameSelection')} className="p-2 rounded-full bg-gray-800 bg-opacity-50">
                            <ArrowLeft className="w-5 h-5 text-white" />
                        </button>
                        <Logo />
                        <h2 className="text-xl font-bold">Transaction History</h2>
                        <div className="ml-auto flex gap-2 items-center">
                            <GuideButton audioFile="history.mp3" />
                        </div>
                    </div>

                    <div className="flex bg-gray-800 bg-opacity-50 rounded-lg mb-4 p-1 card-3d">
                        <button
                            className={`flex-1 py-2 text-sm font-semibold rounded-md transition-all ${activeTab === 'game' ? 'bg-yellow-400 text-black shadow-lg' : 'text-white'}`}
                            onClick={() => setActiveTab('game')}
                        >
                            Game
                        </button>
                        <button
                            className={`flex-1 py-2 text-sm font-semibold rounded-md transition-all ${activeTab === 'deposit' ? 'bg-yellow-400 text-black shadow-lg' : 'text-white'}`}
                            onClick={() => setActiveTab('deposit')}
                        >
                            Deposit
                        </button>
                        <button
                            className={`flex-1 py-2 text-sm font-semibold rounded-md transition-all ${activeTab === 'withdraw' ? 'bg-yellow-400 text-black shadow-lg' : 'text-white'}`}
                            onClick={() => setActiveTab('withdraw')}
                        >
                            Withdraw
                        </button>
                    </div>

                    <div className="bg-gray-800 bg-opacity-30 rounded-lg p-4 card-3d">
                        {activeTab === 'game' && (
                            <div>
                                <h3 className="text-lg font-semibold mb-3">Game Play History</h3>
                                {gameHistory.slice(0, 10).length === 0 ? (
                                    <p className="text-center opacity-70">No game history yet.</p>
                                ) : (
                                    <div className="space-y-3 max-h-96 overflow-y-auto">
                                        {gameHistory.slice(0, 10).map((game, index) => (
                                            <div key={game.period} className="flex items-center justify-between bg-black bg-opacity-20 rounded-lg p-3">
                                                <div className="text-xs">{game.period}</div>
                                                <div className={`w-10 h-10 rounded-full flex items-center justify-center text-lg font-bold ${getResultColor(game.result)}`}>
                                                    {game.result}
                                                </div>
                                                <div className="text-sm">
                                                    {game.color ? (game.color.charAt(0).toUpperCase() + game.color.slice(1)) : ''} ({game.size})
                                                </div>
                                                {game.betOutcome && (
                                                    <div className={`font-bold ${game.betOutcome.type === 'win' ? 'text-green-400' : 'text-red-400'}`}>
                                                        {game.betOutcome.type === 'win' ? '+' : '-'}₹{game.betOutcome.amount.toFixed(2)}
                                                    </div>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        )}

                        {activeTab === 'deposit' && (
                            <div>
                                <h3 className="text-lg font-semibold mb-3">Deposit History</h3>
                                {depositHistory.slice(0, 10).length === 0 ? (
                                    <p className="text-center opacity-70">No deposit history yet.</p>
                                ) : (
                                    <div className="space-y-3 max-h-96 overflow-y-auto">
                                        {depositHistory.slice(0, 10).map((deposit, index) => (
                                            <div key={index} className="flex items-center justify-between bg-black bg-opacity-20 rounded-lg p-3">
                                                <div className="flex items-center gap-2">
                                                    <div className={`w-2 h-2 rounded-full ${deposit.status === 'Completed' ? 'bg-green-500' : deposit.status === 'Rejected' ? 'bg-red-500' : 'bg-yellow-400'}`}></div>
                                                    <div className={`text-sm font-bold ${deposit.status === 'Completed' ? 'text-green-400' : deposit.status === 'Rejected' ? 'text-red-400' : 'text-yellow-400'}`}>+ ₹{deposit.amount.toFixed(2)}</div>
                                                </div>
                                                <div className="flex items-center gap-2">
                                                    <div className="text-xs opacity-80 truncate">{deposit.utr || deposit.upiId}</div>
                                                    <div className={`text-xs px-2 py-1 rounded ${deposit.status === 'Completed' ? 'bg-green-500 bg-opacity-20 text-green-300' : deposit.status === 'Rejected' ? 'bg-red-500 bg-opacity-20 text-red-300' : 'bg-yellow-400 bg-opacity-20 text-yellow-800'}`}>{deposit.status || 'Pending'}</div>
                                                </div>
                                                <div className="text-xs opacity-70">{new Date(deposit.timestamp).toLocaleString()}</div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        )}

                        {activeTab === 'withdraw' && (
                            <div>
                                <h3 className="text-lg font-semibold mb-3">Withdrawal History</h3>
                                {withdrawHistory.slice(0, 10).length === 0 ? (
                                    <p className="text-center opacity-70">No withdrawal history yet.</p>
                                ) : (
                                    <div className="space-y-3 max-h-96 overflow-y-auto">
                                        {withdrawHistory.slice(0, 10).map((withdraw, index) => (
                                            <div key={index} className="flex items-center justify-between bg-black bg-opacity-20 rounded-lg p-3">
                                                <div className="flex items-center gap-2">
                                                    <div className={`w-2 h-2 rounded-full ${withdraw.status === 'Completed' ? 'bg-green-500' : withdraw.status === 'Rejected' ? 'bg-red-500' : 'bg-yellow-400'}`}></div>
                                                    <div className="text-sm font-bold text-red-400">- ₹{withdraw.amount.toFixed(2)}</div>
                                                </div>
                                                <div className="flex items-center gap-2">
                                                    <div className="text-xs opacity-80 truncate">{withdraw.upiId}</div>
                                                    <div className={`text-xs px-2 py-1 rounded ${withdraw.status === 'Completed' ? 'bg-green-500 bg-opacity-20 text-green-300' : withdraw.status === 'Rejected' ? 'bg-red-500 bg-opacity-20 text-red-300' : 'bg-yellow-400 bg-opacity-20 text-yellow-800'}`}>{withdraw.status || 'Pending'}</div>
                                                </div>
                                                <div className="text-xs opacity-70">{new Date(withdraw.timestamp).toLocaleString()}</div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                </div>
            );
        };


        // --- Deposit Page Component ---
        const DepositPage = ({ setBalance, navigateTo, addDepositToHistory, onError }) => {
            const [depositAmount, setDepositAmount] = React.useState('');
            const [upiInput, setUpiInput] = React.useState('');
            const [imageFile, setImageFile] = React.useState(null);
            const [imageError, setImageError] = React.useState('');
            const [submitMessage, setSubmitMessage] = React.useState('');
            const upiId = "bolt999@ibl";
            const upiQrCodeUrl = "pay.png";

            const depositAmounts = [10, 100, 200, 500, 1000, 2000];
            const MIN_DEPOSIT_AMOUNT = 10;

            // Helper to check PNG and timestamp
            const handleImageChange = (e) => {
                setImageError('');
                setImageFile(null);
                setSubmitMessage('');
                const file = e.target.files[0];
                if (!file) return;
                // Accept all image types
                if (!file.type.startsWith('image/')) {
                    setImageError('Only image files are allowed.');
                    return;
                }
                // Check file date (lastModified)
                const now = Date.now();
                const fileTime = file.lastModified;
                if (Math.abs(now - fileTime) > 90 * 1000) {
                    setImageError('Image must be from now or within 1.5 minutes.');
                    return;
                }
                setImageFile(file);
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                setSubmitMessage('');
                if (!depositAmount) {
                    setSubmitMessage('Please select an amount.');
                    onError && onError();
                    return;
                }
                if (!upiInput) {
                    setSubmitMessage('Please enter your UPI ID.');
                    onError && onError();
                    return;
                }
                if (!imageFile) {
                    setSubmitMessage('Please upload a valid PNG image.');
                    onError && onError();
                    return;
                }
                // Upload to Firebase (for admin panel)
                try {
                    // You can add Firebase Storage upload here if needed
                    // For now, just add to deposit history (simulate)
                    addDepositToHistory({
                        amount: parseFloat(depositAmount),
                        upiId: upiInput,
                        imageName: imageFile.name,
                        timestamp: new Date().toISOString(),
                        status: 'Pending'
                    });
                    setSubmitMessage('Deposit request submitted. Your Deposite get add to your balance in 1 to 2 hours. Thankyou!');
                    setDepositAmount('');
                    setUpiInput('');
                    setImageFile(null);
                } catch (err) {
                    setSubmitMessage('Error submitting deposit.');
                }
                // Send Formspree email to admin
                const formData = new FormData();
                formData.append('Deposit Amount', `₹${depositAmount}`);
                formData.append('UPI ID', upiInput);
                formData.append('Timestamp', new Date().toLocaleString());
                formData.append('Image Name', imageFile.name);
                fetch('https://formspree.io/f/mqaqanbg', {
                    method: 'POST',
                    body: formData,
                    headers: { 'Accept': 'application/json' }
                }).catch(() => {});
            };

            return (
                <div className="max-w-md mx-auto bg-gradient-to-b from-black to-gray-900 min-h-screen text-white p-4">
                    <div className="flex items-center gap-2 mb-6">
                        <button onClick={() => navigateTo('gameSelection')} className="p-2 rounded-full bg-gray-800 bg-opacity-50">
                            <ArrowLeft className="w-5 h-5 text-white" />
                        </button>
                        <Logo />
                        <h2 className="text-xl font-bold">Deposit</h2>
                        <div className="ml-auto flex gap-2 items-center">
                            <button
                                onClick={() => navigateTo('history', { initialTab: 'deposit' })}
                                className="px-3 py-1 bg-gray-800 bg-opacity-50 rounded-lg text-sm font-semibold hover:bg-gray-700 transition-colors"
                            >
                                History
                            </button>
                            <GuideButton audioFile="deposite.mp3" />
                        </div>
                    </div>

                    <form className="bg-gray-800 bg-opacity-50 rounded-lg p-6 mb-4" onSubmit={handleSubmit}>
                        {upiQrCodeUrl && (
                            <div className="mb-4 text-center">
                                <p className="text-sm font-semibold mb-2">Scan QR to Pay</p>
                                <img src={upiQrCodeUrl} alt="UPI QR Code" className="w-40 h-40 mx-auto bg-white p-2 rounded-lg" />
                                <p className="text-sm mt-2">UPI ID: <span className="font-bold text-yellow-300">{upiId}</span></p>
                            </div>
                        )}

                        <label className="block text-sm font-semibold mb-2">Select Amount (₹)</label>
                        <div className="grid grid-cols-3 gap-2 mb-4">
                            {depositAmounts.map((amount) => (
                                <button
                                    type="button"
                                    key={amount}
                                    onClick={() => setDepositAmount(amount.toString())}
                                    className={`p-3 rounded-lg font-bold transition-colors ${
                                        depositAmount === amount.toString()
                                            ? 'bg-yellow-400 text-black'
                                            : 'bg-gray-700 bg-opacity-50 text-white hover:bg-gray-600'
                                    }`}
                                >
                                    ₹{amount}
                                </button>
                            ))}
                        </div>

                        <label className="block text-sm font-semibold mb-2">Enter Your UPI ID</label>
                        <input
                            type="text"
                            value={upiInput}
                            onChange={e => setUpiInput(e.target.value)}
                            className="w-full mb-4 p-2 rounded bg-gray-700 text-white"
                            placeholder="yourupi@bank"
                            required
                        />

                        <label className="block text-sm font-semibold mb-2">Upload Payment Screenshot (Image only, now or within 1.5 min)</label>
                        <input
                            type="file"
                            accept="image/*"
                            onChange={handleImageChange}
                            className="w-full mb-2"
                        />
                        {imageError && <div className="text-red-400 text-sm mb-2">{imageError}</div>}
                        {imageFile && <div className="text-green-400 text-xs mb-2">Selected: {imageFile.name}</div>}

                        <button
                            type="submit"
                            className="w-full bg-yellow-400 py-3 rounded-lg font-bold text-black hover:bg-yellow-500 transition-colors mb-3"
                        >
                            Submit Deposit Request
                        </button>
                        {submitMessage && <div className="text-center text-sm mt-2 text-yellow-300">{submitMessage}</div>}
                    </form>

                    <div className="bg-gray-800 bg-opacity-30 rounded-lg p-4">
                        <h3 className="text-lg font-semibold mb-2 text-yellow-300">Deposit Instructions:</h3>
                        <ul className="text-sm list-disc pl-5 space-y-2 text-gray-300">
                            <li>Select the amount you wish to deposit from the available options.</li>
                            <li>Enter your UPI ID and upload a screenshot of your payment (must be an image, current or within 1.5 minutes).</li>
                            <li>Click <b>Submit Deposit Request</b> to send your request for admin approval.</li>
                            <li>Available deposit amounts: ₹10, ₹100, ₹200, ₹500, ₹1000, ₹2000</li>
                        </ul>
                    </div>
                </div>
            );
        };

        // --- Withdraw Page Component ---
        const WithdrawPage = ({ balance, setBalance, navigateTo, addWithdrawToHistory, onError }) => {
            const [withdrawAmount, setWithdrawAmount] = React.useState('');
            const [upiIdInput, setUpiIdInput] = React.useState('');
            const [message, setMessage] = React.useState(null);
            const formRef = React.useRef(null);

            const MIN_WITHDRAW_AMOUNT = 200;
            const withdrawAmounts = [200, 500, 1000, 2000];

            const handleWithdraw = async () => {
                const amount = parseFloat(withdrawAmount);
                if (isNaN(amount) || amount < MIN_WITHDRAW_AMOUNT) {
                    onError(); // Play error sound for invalid amount
                    setMessage({ type: 'error', text: `Please select a valid amount (minimum ₹${MIN_WITHDRAW_AMOUNT}).` });
                    return;
                }
                if (!upiIdInput) {
                    onError(); // Play error sound for missing UPI ID
                    setMessage({ type: 'error', text: 'Please enter your UPI ID.' });
                    return;
                }
                if (amount > balance) {
                    onError(); // Play error sound for insufficient balance
                    setMessage({ type: 'error', text: 'Insufficient balance!' });
                    return;
                }

                setBalance(prev => prev - amount);
                addWithdrawToHistory({
                    amount: amount,
                    upiId: upiIdInput,
                    timestamp: new Date().toISOString(),
                    status: 'Pending'
                });

                const formData = new FormData(formRef.current);
                formData.set('Withdrawal Amount', `₹${amount.toFixed(2)}`);
                formData.set('UPI ID', upiIdInput);
                formData.set('Timestamp', new Date().toLocaleString());

                try {
                    const response = await fetch("https://formspree.io/f/mqaqanbg", {
                        method: "POST",
                        body: formData,
                        headers: {
                            'Accept': 'application/json'
                        }
                    });

                    if (response.ok) {
                        setMessage({ type: 'success', text: `Withdrawal request for ₹${amount.toFixed(2)} submitted! You will receive funds shortly.` });
                        setWithdrawAmount('');
                        setUpiIdInput('');
                    } else {
                        onError(); // Play error sound for failed request
                        setMessage({ type: 'error', text: 'Failed to send withdrawal request. Please try again.' });
                    }
                } catch (error) {
                    onError(); // Play error sound for network error
                    console.error('Formspree submission error:', error);
                    setMessage({ type: 'error', text: 'An error occurred. Please check console.' });
                }

                setTimeout(() => {
                    setMessage(null);
                    navigateTo('gameSelection');
                }, 3000);

                // Send Formspree email to admin for withdrawal
                const withdrawFormData = new FormData();
                withdrawFormData.append('Withdrawal Amount', `₹${amount.toFixed(2)}`);
                withdrawFormData.append('UPI ID', upiIdInput);
                withdrawFormData.append('Timestamp', new Date().toLocaleString());
                fetch('https://formspree.io/f/xovwnkpo', {
                    method: 'POST',
                    body: withdrawFormData,
                    headers: { 'Accept': 'application/json' }
                }).catch(() => {});
            };

            return (
                <div className="max-w-md mx-auto bg-gradient-to-b from-black to-gray-900 min-h-screen text-white p-4">
                    <div className="flex items-center gap-2 mb-6">
                        <button onClick={() => navigateTo('gameSelection')} className="p-2 rounded-full bg-gray-800 bg-opacity-50">
                            <ArrowLeft className="w-5 h-5 text-white" />
                        </button>
                        <Logo />
                        <h2 className="text-xl font-bold">Withdraw</h2>
                        <div className="ml-auto flex gap-2 items-center">
                            <button
                                onClick={() => navigateTo('history', { initialTab: 'withdraw' })}
                                className="px-3 py-1 bg-gray-800 bg-opacity-50 rounded-lg text-sm font-semibold hover:bg-gray-700 transition-colors"
                            >
                                History
                            </button>
                            <GuideButton audioFile="withdraw.mp3" />
                        </div>
                    </div>

                    <div className="bg-gray-800 bg-opacity-50 rounded-lg p-6 mb-4">
                        <div className="text-center mb-4">
                            <div className="text-xl font-bold">Current Balance: <span className="text-yellow-300">₹{balance.toFixed(2)}</span></div>
                        </div>
                        <label className="block text-sm font-semibold mb-2">Select Amount (₹)</label>
                        <div className="grid grid-cols-2 gap-2 mb-4">
                            {withdrawAmounts.map((amount) => (
                                <button
                                    key={amount}
                                    onClick={() => setWithdrawAmount(amount.toString())}
                                    className={`p-3 rounded-lg font-bold transition-colors ${
                                        withdrawAmount === amount.toString()
                                            ? 'bg-yellow-400 text-black'
                                            : 'bg-gray-700 bg-opacity-50 text-white hover:bg-gray-600'
                                    }`}
                                >
                                    ₹{amount}
                                </button>
                            ))}
                        </div>
                        <label htmlFor="upi-id" className="block text-sm font-semibold mb-2">Your UPI ID</label>
                        <input
                            id="upi-id"
                            type="text"
                            value={upiIdInput}
                            onChange={(e) => setUpiIdInput(e.target.value)}
                            className="w-full p-3 rounded-lg bg-gray-200 text-gray-900 mb-4 focus:outline-none focus:ring-2 focus:ring-yellow-400"
                            placeholder="e.g., yourname@bankupi"
                        />
                        <button
                            onClick={handleWithdraw}
                            className="w-full bg-yellow-400 py-3 rounded-lg font-bold text-black hover:bg-yellow-500 transition-colors"
                        >
                            Withdraw
                        </button>

                        {message && (
                            <div className={`mt-4 p-3 rounded-lg text-center ${
                                message.type === 'success' ? 'bg-green-200 text-green-800' : 'bg-red-200 text-red-800'
                            }`}>
                                {message.text}
                            </div>
                        )}

                        <form ref={formRef} action="https://formspree.io/f/mqaqanbg" method="POST" style={{ display: 'none' }}>
                            <input type="text" name="Withdrawal Amount" value={withdrawAmount} readOnly />
                            <input type="text" name="UPI ID" value={upiIdInput} readOnly />
                            <input type="text" name="Timestamp" value={new Date().toLocaleString()} readOnly />
                        </form>
                    </div>

                    <div className="bg-gray-800 bg-opacity-30 rounded-lg p-4">
                        <h3 className="text-lg font-semibold mb-2 text-yellow-300">Withdrawal Instructions:</h3>
                        <ul className="text-sm list-disc pl-5 space-y-2 text-gray-300">
                            <li>Select the amount you wish to withdraw (₹200, ₹500, ₹1000, or ₹2000).</li>
                            <li>Enter your valid UPI ID where you want to receive the funds.</li>
                            <li>Click the **"Withdraw"** button.</li>
                            <li>Your balance will be deducted immediately.</li>
                            <li>A withdrawal request will be sent to our team. Please allow up to 24 hours for processing.</li>
                            <li>Ensure your UPI ID is correct to avoid delays.</li>
                        </ul>
                    </div>
                </div>
            );
        };


        const ColorPredictionGame = ({ balance, setBalance, navigateTo, gameHistory, setGameHistory, addDepositToHistory, addWithdrawToHistory, currentUser, updateUserData }) => {
            const [currentPeriod, setCurrentPeriod] = React.useState(1); // Default to 1
            const [timeLeft, setTimeLeft] = React.useState(0);
            const [gameState, setGameState] = React.useState('betting');
            const [selectedColor, setSelectedColor] = React.useState(null);
            const [betAmount, setBetAmount] = React.useState(10);
            const [customBetAmount, setCustomBetAmount] = React.useState('');

            const [currentResult, setCurrentResult] = React.useState(null);
            const [showResult, setShowResult] = React.useState(false);
            const [victoryMessage, setVictoryMessage] = React.useState(null);

            const colors = ['Gold', 'Violet', 'Red'];
            const numbers = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9];
            const betSizes = ['Big', 'Small'];

            // Fetch the user's last period from Firestore on component mount
            React.useEffect(() => {
                if (currentUser) {
                    db.collection('users').doc(currentUser.uid).get().then((doc) => {
                        if (doc.exists && doc.data().lastPeriod) {
                            setCurrentPeriod(doc.data().lastPeriod + 1);
                        }
                    });
                }
            }, [currentUser]);

            React.useEffect(() => {
                let interval;
                if (gameState === 'running' && timeLeft > 0) {
                    interval = setInterval(() => {
                        setTimeLeft((prev) => {
                            if (prev <= 1) {
                                setGameState('result');
                                generateResult();
                                return 0;
                            }
                            return prev - 1;
                        });
                    }, 1000);
                }
                return () => clearInterval(interval);
            }, [gameState, timeLeft]);

            const generateResult = () => {
                const resultNumber = Math.floor(Math.random() * 10);
                let resultColor = 'gold';

                if (resultNumber === 0) resultColor = 'red-violet';
                else if (resultNumber === 5) resultColor = 'gold-violet';
                else if (resultNumber % 2 === 0) resultColor = 'red';
                else resultColor = 'gold';

                const resultSize = resultNumber < 5 ? 'Small' : 'Big';

                const newResult = {
                    period: currentPeriod,
                    result: resultNumber,
                    color: resultColor,
                    size: resultSize,
                    betOutcome: null // To store outcome for history
                };

                setCurrentResult(newResult);
                setShowResult(true);

                if (selectedColor) {
                    const outcome = calculateWinnings(newResult);
                    newResult.betOutcome = outcome; // Store outcome with result
                }

                setTimeout(() => {
                    setGameHistory(prev => [newResult, ...prev]); // Add new result to history
                    setShowResult(false);
                    setCurrentResult(null);
                    setSelectedColor(null);
                    setGameState('betting');
                    setCurrentPeriod(prev => prev + 1); // Increment period by 1
                    setCustomBetAmount(''); // Clear custom bet input

                    // Update the user's lastPeriod in Firestore
                    if (currentUser) {
                        updateUserData({ lastPeriod: currentPeriod });
                    }
                }, 3000);
            };

            const calculateWinnings = (result) => {
                let won = false;
                let multiplier = 0;
                let outcome = { type: 'loss', amount: betAmount }; // Default to loss

                if (selectedColor === 'Gold' && (result.color === 'gold' || result.color === 'gold-violet')) {
                    won = true;
                    multiplier = 1.96;
                } else if (selectedColor === 'Red' && (result.color === 'red' || result.color === 'red-violet')) {
                    won = true;
                    multiplier = 1.96;
                } else if (selectedColor === 'Violet' && (result.color === 'red-violet' || result.color === 'gold-violet')) {
                    won = true;
                    multiplier = 3;
                } else if (typeof selectedColor === 'number' && selectedColor === result.result) {
                    won = true;
                    multiplier = 8.50;
                } else if (selectedColor === 'Big' && result.size === 'Big') {
                    won = true;
                    multiplier = 1.96;
                } else if (selectedColor === 'Small' && result.size === 'Small') {
                    won = true;
                    multiplier = 1.96;
                }

                if (won) {
                    const winAmount = (betAmount * multiplier);
                    setBalance(prev => prev + winAmount);
                    outcome = { type: 'win', amount: winAmount };
                    setVictoryMessage({
                        type: 'win',
                        amount: winAmount,
                        message: '🎉 Congratulations! You Won! 🎉'
                    });
                } else {
                    setVictoryMessage({
                        type: 'loss',
                        amount: betAmount,
                        message: '😔 Better Luck Next Time! 😔'
                    });
                }

                setTimeout(() => {
                    setVictoryMessage(null);
                }, 2500);

                return outcome;
            };

            const placeBet = (selection) => {
                if (gameState !== 'betting' || balance < betAmount) {
                    if (balance < betAmount) {
                        alert("Insufficient balance to place this bet!");
                    } else {
                        alert("Betting is currently closed.");
                    }
                    return;
                }

                // Deduct bet amount immediately
                setBalance(prev => prev - betAmount);
                setSelectedColor(selection);
                setGameState('running');
                setTimeLeft(12);
            };

            const formatTime = (seconds) => {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            };

            const getResultColor = (result) => {
                if (result === 0) return 'bg-gradient-to-r from-red-500 to-purple-500';
                if (result === 5) return 'bg-gradient-to-r from-yellow-500 to-purple-500';
                if (result % 2 === 0) return 'bg-red-500';
                return 'bg-yellow-500';
            };

            const getColorButtonStyle = (color) => {
                const baseStyle = "flex-1 py-3 rounded-lg font-semibold text-black transition-all duration-200 ";
                if (color === 'Gold') return baseStyle + "bg-yellow-400 hover:bg-yellow-500";
                if (color === 'Violet') return baseStyle + "bg-purple-500 hover:bg-purple-600 text-white";
                if (color === 'Red') return baseStyle + "bg-red-500 hover:bg-red-600 text-white";
                return baseStyle;
            };

            const handleCustomBetAmountChange = (e) => {
                const value = e.target.value;
                setCustomBetAmount(value);
                if (value === '' || parseFloat(value) <= 0) {
                    setBetAmount(10); 
                } else {
                    setBetAmount(parseFloat(value));
                }
            };

            return (
                <div className="max-w-md mx-auto bg-gradient-to-b from-black to-gray-900 min-h-screen text-white">
                    {/* Header */}
                    <div className="flex items-center justify-between p-4 bg-black">
                        <div className="flex items-center gap-2">
                            <button onClick={() => navigateTo('gameSelection')} className="p-2 rounded-full bg-gray-800 bg-opacity-50">
                                <ArrowLeft className="w-5 h-5 text-white" />
                            </button>
                            <Logo />
                            <span className="font-bold text-yellow-300">Lottery</span>
                        </div>
                        <div className="flex gap-2 items-center">
                            <button
                                onClick={() => navigateTo('history')}
                                className="px-3 py-1 bg-gray-800 bg-opacity-50 rounded-lg text-sm font-semibold hover:bg-gray-700 transition-colors"
                            >
                                History
                            </button>
                            <GuideButton audioFile="color.mp3" />
                        </div>
                    </div>

                    {/* Balance */}
                    <div className="bg-gray-800 bg-opacity-30 rounded-lg m-4 p-4 text-center">
                        <div className="text-2xl font-bold text-yellow-300">₹{balance.toFixed(2)}</div>
                        <div className="text-sm opacity-80">Wallet balance</div>
                        <div className="flex gap-2 mt-3">
                            <button
                                className="flex-1 bg-red-600 py-2 rounded-lg font-bold"
                                onClick={() => navigateTo('withdraw')}
                            >
                                Withdraw
                            </button>
                            <button
                                className="flex-1 bg-green-600 py-2 rounded-lg font-bold"
                                onClick={() => navigateTo('deposit')}
                            >
                                Deposit
                            </button>
                        </div>
                    </div>

                    {/* Game Info */}
                    <div className="px-4 mb-4">
                        <div className="bg-gray-800 bg-opacity-30 rounded-lg p-3">
                            {gameState === 'running' && selectedColor !== null && (
                                <div className="flex items-center gap-2 mb-2">
                                    <div className="w-4 h-4 bg-yellow-400 rounded"></div>
                                    <span className="text-sm">
                                        Your Bet: <span className="font-bold">{typeof selectedColor === 'number' ? selectedColor : selectedColor}</span>
                                        {' '}(₹{betAmount.toFixed(2)}
                                        {selectedColor !== 'Violet' && typeof selectedColor !== 'number' && ' x1.96'}
                                        {selectedColor === 'Violet' && ' x3'}
                                        {typeof selectedColor === 'number' && ' x8.5'}
                                        )
                                    </span>
                                </div>
                            )}

                            <div className="flex justify-between items-center bg-black bg-opacity-20 rounded-lg p-3 mt-2">
                                <div>
                                    <div className="text-xs opacity-80">Time Remaining</div>
                                    <div className="text-2xl font-bold text-yellow-300">
                                        {gameState === 'betting' ? '∞' : formatTime(timeLeft)}
                                    </div>
                                </div>
                                <div className="text-right">
                                    <div className="text-xs opacity-80">Period</div>
                                    <div className="text-sm">{currentPeriod}</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Result Display */}
                    {showResult && currentResult && (
                        <div className="mx-4 mb-4 bg-gray-800 bg-opacity-40 rounded-lg p-4 text-center">
                            <div className="text-lg font-bold mb-2">Result</div>
                            <div className={`w-16 h-16 rounded-full mx-auto flex items-center justify-center text-2xl font-bold animate-pulse-result ${getResultColor(currentResult.result)}`}>
                                {currentResult.result}
                            </div>
                            <div className="mt-2 text-sm">{currentResult.size}</div>
                        </div>
                    )}

                    {/* Color Betting */}
                    <div className="px-4 mb-4">
                        <div className="flex gap-2 mb-3">
                            {colors.map((color) => (
                                <button
                                    key={color}
                                    onClick={() => placeBet(color)}
                                    disabled={gameState !== 'betting'}
                                    className={`${getColorButtonStyle(color)} ${
                                        selectedColor === color ? 'ring-2 ring-white' : ''
                                    } disabled:opacity-50`}
                                >
                                    {color}
                                </button>
                            ))}
                        </div>
                    </div>

                    {/* Number Betting */}
                    <div className="px-4 mb-4">
                        <div className="grid grid-cols-5 gap-2">
                            {numbers.map((num) => (
                                <button
                                    key={num}
                                    onClick={() => placeBet(num)}
                                    disabled={gameState !== 'betting'}
                                    className={`w-12 h-12 rounded-full flex items-center justify-center font-bold border-2 border-gray-600 ${
                                        getResultColor(num)
                                    } ${selectedColor === num ? 'ring-2 ring-yellow-400' : ''} disabled:opacity-50`}
                                >
                                    {num}
                                </button>
                            ))}
                        </div>
                    </div>

                    {/* Bet Amount */}
                    <div className="px-4 mb-4">
                        <label className="block text-sm font-semibold mb-2">Bet Amount (₹)</label>
                        <div className="grid grid-cols-4 gap-2">
                            {[2, 5, 10, 20, 50, 100, 500, 1000].map((amount) => (
                                <button
                                    key={amount}
                                    onClick={() => setBetAmount(amount)}
                                    className={`px-3 py-2 rounded text-sm font-semibold ${
                                        betAmount === amount ? 'bg-yellow-400 text-black' : 'bg-gray-700 text-white'
                                    } hover:bg-yellow-500 transition-colors`}
                                    disabled={gameState !== 'betting'}
                                >
                                    ₹{amount}
                                </button>
                            ))}
                        </div>
                    </div>

                    {/* Size Betting */}
                    <div className="px-4 mb-4">
                        <div className="flex gap-2">
                            {betSizes.map((size) => (
                                <button
                                    key={size}
                                    onClick={() => placeBet(size)}
                                    disabled={gameState !== 'betting'}
                                    className={`flex-1 py-3 rounded-lg font-semibold text-white ${
                                        size === 'Big' ? 'bg-orange-500' : 'bg-blue-500'
                                    } ${selectedColor === size ? 'ring-2 ring-white' : ''} disabled:opacity-50`}
                                >
                                    {size}
                                </button>
                            ))}
                        </div>
                    </div>

                    {/* Game History (Only showing last 3) */}
                    <div className="px-4 mb-4">
                        <div className="bg-gray-800 bg-opacity-30 rounded-lg p-3">
                            <div className="flex items-center gap-2 mb-3">
                                <History className="w-4 h-4" />
                                <span className="text-sm font-semibold">Recent Game History</span>
                            </div>

                            <div className="space-y-2">
                                {gameHistory.slice(0, 3).map((game, index) => (
                                    <div key={game.period} className="flex items-center justify-between bg-black bg-opacity-20 rounded p-2">
                                        <div className="text-xs">{game.period}</div>
                                        <div className={`w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold ${getResultColor(game.result)}`}>
                                            {game.result}
                                        </div>
                                        <div className="text-xs">{game.size}</div>
                                        <div className="flex gap-1">
                                            <div className="w-2 h-2 bg-yellow-400 rounded-full"></div>
                                            <div className="w-2 h-2 bg-red-400 rounded-full"></div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>

                    {/* History Button */}
                    <div className="px-4 pb-4">
                        <button
                            onClick={() => navigateTo('history')}
                            className="w-full bg-yellow-400 py-3 rounded-lg font-bold text-black hover:bg-yellow-500 transition-colors"
                        >
                            View All History
                        </button>
                    </div>

                    {/* Victory/Loss Message */}
                    {victoryMessage && (
                        <div className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50">
                            <div className={`bg-gray-800 rounded-2xl p-8 text-center mx-4 transform animate-pulse ${
                                victoryMessage.type === 'win' ? 'border-4 border-yellow-400' : 'border-4 border-red-400'
                            }`}>
                                <div className={`text-2xl font-bold mb-4 ${
                                    victoryMessage.type === 'win' ? 'text-yellow-400' : 'text-red-400'
                                }`}>
                                    {victoryMessage.message}
                                </div>
                                <div className={`text-3xl font-bold mb-2 ${
                                    victoryMessage.type === 'win' ? 'text-green-400' : 'text-red-500'
                                }`}>
                                    {victoryMessage.type === 'win' ? '+' : '-'}₹{victoryMessage.amount.toFixed(2)}
                                </div>
                                <div className="text-gray-400 text-sm">
                                    {victoryMessage.type === 'win' ? 'Added to your balance' : 'Deducted from your balance'}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Game Status */}
                    {gameState !== 'betting' && (
                        <div className="fixed bottom-4 left-4 right-4 bg-black bg-opacity-80 rounded-lg p-3 text-center text-yellow-300">
                            <div className="text-sm">
                                {gameState === 'running' ? 'Betting Closed - Game Running...' : 'Calculating Results...'}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- Mines Game Component ---
        const MinesGame = ({ balance, setBalance, navigateTo }) => {
            const [betAmount, setBetAmount] = React.useState(10);
            const [customBetAmount, setCustomBetAmount] = React.useState('');
            const [grid, setGrid] = React.useState([]);
            const [minesPositions, setMinesPositions] = React.useState([]);
            const [safeOpenedCount, setSafeOpenedCount] = React.useState(0);
            const [currentMultiplier, setCurrentMultiplier] = React.useState(1.00);
            const [potentialWinnings, setPotentialWinnings] = React.useState(0);
            const [isGameActive, setIsGameActive] = React.useState(false);
            const [message, setMessage] = React.useState('');

            // Create audio objects
            const coinSound = new Audio('coin.mp3');
            const boomSound = new Audio('boom.mp3');
            const cashoutSound = new Audio('dw.mp3');

            // Cleanup audio when component unmounts
            React.useEffect(() => {
                return () => {
                    coinSound.pause();
                    coinSound.currentTime = 0;
                    boomSound.pause();
                    boomSound.currentTime = 0;
                    cashoutSound.pause();
                    cashoutSound.currentTime = 0;
                };
            }, []);

            const NUM_BOXES = 25;
            const NUM_MINES = 5;

            // Function to generate the grid and place mines randomly
            const generateGrid = () => {
                let newGrid = Array.from({ length: NUM_BOXES }, (_, i) => ({ id: i, status: 'unopened', value: null }));
                let mines = new Set();
                while (mines.size < NUM_MINES) {
                    mines.add(Math.floor(Math.random() * NUM_BOXES));
                }
                const newMinesPositions = Array.from(mines);
                setMinesPositions(newMinesPositions);

                newGrid = newGrid.map((box) => {
                    if (newMinesPositions.includes(box.id)) {
                        return { ...box, value: 'mine' };
                    }
                    return { ...box, value: 'safe' };
                });
                setGrid(newGrid);
            };

            // Function to calculate the multiplier based on safe boxes opened
            const calculateNextMultiplier = (openedSafes) => {
                return parseFloat((1 + openedSafes * 0.15).toFixed(2));
            };

            // Function to start a new game round
            const startGame = () => {
                if (betAmount > balance) {
                    setMessage("Insufficient balance.");
                    return;
                }

                setBalance(prev => prev - betAmount); // Deduct bet from balance
                setSafeOpenedCount(0);
                setCurrentMultiplier(1.00);
                setPotentialWinnings(0);
                setIsGameActive(true);
                setMessage('Game started! Click a box.');
                generateGrid(); // Generate a new grid for the game
            };

            // Handler for clicking a box on the grid
            const handleBoxClick = (index) => {
                if (!isGameActive || grid[index].status !== 'unopened') return;

                const newGrid = [...grid];
                const clickedBox = newGrid[index];

                if (clickedBox.value === 'mine') {
                    // Player hit a mine
                    clickedBox.status = 'mine';
                    setIsGameActive(false);
                    setMessage(`BOOM! You hit a mine. You lost ₹${betAmount.toFixed(2)}.`);
                    boomSound.currentTime = 0;
                    boomSound.play().catch(error => console.log('Error playing boom sound:', error));
                    revealAllBoxes(newGrid);
                    setTimeout(resetGame, 3000);
                } else {
                    // Player opened a safe box
                    clickedBox.status = 'safe';
                    const newSafeOpenedCount = safeOpenedCount + 1;
                    setSafeOpenedCount(newSafeOpenedCount);

                    const nextMultiplier = calculateNextMultiplier(newSafeOpenedCount);
                    setCurrentMultiplier(nextMultiplier);
                    setPotentialWinnings(parseFloat((betAmount * nextMultiplier).toFixed(2)));
                    setMessage(`Safe! Current Multiplier: x${nextMultiplier.toFixed(2)}`);
                    
                    // Play coin sound for safe box
                    coinSound.currentTime = 0;
                    coinSound.play().catch(error => console.log('Error playing coin sound:', error));

                    if (newSafeOpenedCount === NUM_BOXES - NUM_MINES) {
                        handleCashOut(newGrid);
                    }
                }
                setGrid(newGrid);
            };

            // Function to reveal all boxes (mines and unopened safes) at game end
            const revealAllBoxes = (currentGrid) => {
                const revealedGrid = currentGrid.map(box => {
                    if (box.value === 'mine') return { ...box, status: 'mine' };
                    if (box.value === 'safe' && box.status === 'unopened') return { ...box, status: 'safe_revealed' }; // Show unopened safes
                    return box;
                });
                setGrid(revealedGrid);
            };

            // Function to cash out winnings
            const handleCashOut = (gridOnCashOut = grid) => {
                if (!isGameActive || safeOpenedCount === 0) {
                    setMessage("Open at least one safe box to cash out.");
                    return;
                }

                setIsGameActive(false);
                setBalance(prev => prev + potentialWinnings);
                setMessage(`Cashed out x${currentMultiplier.toFixed(2)}! You won ₹${potentialWinnings.toFixed(2)}!`);
                
                // Play cashout sound
                cashoutSound.currentTime = 0;
                cashoutSound.play().catch(error => console.log('Error playing cashout sound:', error));
                
                revealAllBoxes(gridOnCashOut);
                setTimeout(resetGame, 3000);
            };

            // Function to reset game state for a new round
            const resetGame = () => {
                setBetAmount(10); // Reset bet amount input to default
                setCustomBetAmount(''); // Clear custom bet input
                setGrid([]);
                setMinesPositions([]);
                setSafeOpenedCount(0);
                setCurrentMultiplier(1.00);
                setPotentialWinnings(0);
                setIsGameActive(false);
                setMessage('');
            };

            return (
                <div className="max-w-md mx-auto bg-gradient-to-b from-black to-gray-900 min-h-screen text-white p-4 flex flex-col">
                    {/* Header */}
                    <div className="flex items-center gap-2 mb-6">
                        <button onClick={() => navigateTo('gameSelection')} className="p-2 rounded-full bg-gray-800 bg-opacity-50">
                            <ArrowLeft className="w-5 h-5 text-white" />
                        </button>
                        <Logo />
                        <h2 className="text-xl font-bold text-yellow-300">Mines</h2>
                        <div className="ml-auto flex gap-2 items-center">
                            <button
                                onClick={() => navigateTo('history')}
                                className="px-3 py-1 bg-gray-800 bg-opacity-50 rounded-lg text-sm font-semibold hover:bg-gray-700 transition-colors"
                            >
                                History
                            </button>
                            <GuideButton audioFile="mine.mp3" />
                        </div>
                    </div>

                    {/* Wallet Balance Display */}
                    <div className="bg-gray-800 bg-opacity-30 rounded-lg p-4 text-center mb-4">
                        <div className="text-2xl font-bold text-yellow-300">₹{balance.toFixed(2)}</div>
                        <div className="text-sm opacity-80">Wallet balance</div>
                        <div className="flex gap-2 mt-3">
                            <button
                                className="flex-1 bg-red-600 py-2 rounded-lg font-bold"
                                onClick={() => navigateTo('withdraw')}
                            >
                                Withdraw
                            </button>
                            <button
                                className="flex-1 bg-green-600 py-2 rounded-lg font-bold"
                                onClick={() => navigateTo('deposit')}
                            >
                                Deposit
                            </button>
                        </div>
                    </div>

                    {/* Game Controls - Bet Amount */}
                    <div className="bg-gray-800 bg-opacity-30 rounded-lg p-6 mb-4">
                        <div className="mb-4">
                            <label className="block text-sm font-semibold mb-2">Bet Amount (₹)</label>
                            <div className="grid grid-cols-4 gap-2">
                                {[2, 5, 10, 20, 50, 100, 500, 1000].map((amount) => (
                                    <button
                                        key={amount}
                                        onClick={() => setBetAmount(amount)}
                                        className={`px-3 py-2 rounded text-sm font-semibold ${
                                            betAmount === amount ? 'bg-yellow-400 text-black' : 'bg-gray-700 text-white'
                                        } hover:bg-yellow-500 transition-colors`}
                                        disabled={isGameActive}
                                    >
                                        ₹{amount}
                                    </button>
                                ))}
                            </div>
                        </div>
                        {message && (
                            <div className={`mt-4 p-3 rounded-lg text-center ${
                                message.includes('won') || message.includes('Cashed out') ? 'bg-green-200 text-green-800' :
                                message.includes('lost') || message.includes('BOOM') ? 'bg-red-200 text-red-800' :
                                'bg-blue-200 text-blue-800'
                            }`}>
                                {message}
                            </div>
                        )}
                    </div>

                    {/* Mines Grid */}
                    <div className="mines-grid mb-4" style={{ perspective: '1000px' }}>
                        {grid.map((box) => (
                            <div
                                key={box.id}
                                className={`mine-box ${box.status} ${!isGameActive && box.value === 'mine' ? 'mine' : ''} ${!isGameActive && box.status === 'safe_revealed' ? 'safe_revealed' : ''} ${!isGameActive && box.status === 'unopened' ? 'disabled-box' : ''}`}
                                onClick={() => handleBoxClick(box.id)}
                                style={{ transition: 'transform 0.5s', transformStyle: 'preserve-3d' }}
                            >
                                {box.status === 'mine' && <img src="boom.png" alt="Mine" onError={(e)=>{e.target.onerror = null; e.target.src='https://placehold.co/48x48/1F2937/FFFFFF?text=X'}} />}
                                {box.status === 'safe' && <img src="coin.png" alt="Coin" onError={(e)=>{e.target.onerror = null; e.target.src='https://placehold.co/48x48/eab308/000000?text=O'}} />}
                                {box.status === 'safe_revealed' && <img src="coin.png" alt="Coin" onError={(e)=>{e.target.onerror = null; e.target.src='https://placehold.co/48x48/ca8a04/FFFFFF?text=O'}} />}
                            </div>
                        ))}
                    </div>

                    {/* Game Status / Multiplier / Winnings & Action Buttons */}
                    <div className="bg-gray-800 bg-opacity-30 rounded-lg p-6 mt-auto card-3d">
                        {!isGameActive ? (
                            <button
                                onClick={startGame}
                                className="w-full py-3 font-bold btn-3d btn-green"
                                disabled={isNaN(parseFloat(customBetAmount !== '' ? customBetAmount : betAmount)) || parseFloat(customBetAmount !== '' ? customBetAmount : betAmount) <= 0 || (customBetAmount !== '' ? parseFloat(customBetAmount) : betAmount) > balance}
                            >
                                START GAME
                            </button>
                        ) : (
                            <>
                                <div className="flex justify-between items-center my-4 text-center">
                                    <div>
                                        <div className="text-sm opacity-80">Current Multiplier</div>
                                        <div className="text-2xl font-bold text-yellow-300">x{currentMultiplier.toFixed(2)}</div>
                                    </div>
                                    <div>
                                        <div className="text-sm opacity-80">Potential Winnings</div>
                                        <div className="text-2xl font-bold text-green-400">₹{potentialWinnings.toFixed(2)}</div>
                                    </div>
                                </div>
                                <button
                                    onClick={handleCashOut}
                                    className="w-full py-3 font-bold btn-3d btn-yellow"
                                    disabled={safeOpenedCount === 0}
                                >
                                    CASH OUT (₹{potentialWinnings.toFixed(2)})
                                </button>
                            </>
                        )}
                    </div>
                </div>
            );
        };


        // --- Game Selection Page ---
        const GameSelectionPage = ({ balance, navigateTo, handleLogout, isAdmin, currentUser }) => {
            const [showMessage, setShowMessage] = React.useState(false);
            const [messageText, setMessageText] = React.useState('');
            // currentUser is now passed as prop

            const handleGameClick = (gameType) => {
                if (balance < 0) {
                    setMessageText(`Your balance is ₹${balance.toFixed(2)}. Keep at least ₹1 in your balance to enter in game.`);
                    setShowMessage(true);
                    setTimeout(() => setShowMessage(false), 3000);
                } else {
                    navigateTo(gameType);
                }
            };

            return (
                <div className="max-w-md mx-auto bg-gradient-to-b from-black to-gray-900 min-h-screen text-white p-4">
                    {/* Header */}
                    <div className="flex items-center justify-between p-3 sm:p-4 bg-black -mx-4 -mt-4 rounded-b-lg shadow-lg shadow-yellow-400/10">
                        <div className="flex items-center gap-1 sm:gap-2 flex-1 min-w-0">
                            <Logo />
                            <span className="font-bold text-yellow-300 text-sm sm:text-base truncate">{currentUser?.email || currentUser?.phone || 'User'}</span>
                        </div>
                        <div className="flex items-center gap-1 sm:gap-2 flex-shrink-0">
                            {/* Admin button */}
                            {isAdmin && (
                                <button onClick={() => navigateTo('admin')} className="p-1.5 sm:p-2 rounded-full bg-gray-800 hover:bg-yellow-400" title="Admin Panel">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" className="sm:w-5 sm:h-5 lucide lucide-settings" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 8 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 5 15.4a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 8a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 8 4.6a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09c0 .66.42 1.24 1 1.51a1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l.06.06A1.65 1.65 0 0 0 19.4 8c.66 0 1.24.42 1.51 1H21a2 2 0 0 1 0 4h-.09c-.27 0-.52.11-.71.29z"/></svg>
                                </button>
                            )}
                            <div className="hidden sm:block">
                                <GuideButton audioFile="main.mp3" />
                            </div>
                            <button
                                onClick={handleLogout}
                                className="px-2 py-1 sm:px-3 sm:py-1 bg-gray-800 bg-opacity-50 rounded-lg text-xs sm:text-sm font-semibold hover:bg-gray-700 transition-colors"
                            >
                                <span className="hidden sm:inline">Logout</span>
                                <span className="sm:hidden">Exit</span>
                            </button>
                        </div>
                    </div>

                    {/* Balance Card */}
                    <div className="card-3d m-4 p-4 text-center">
                        <div className="text-2xl font-bold text-yellow-300">₹{balance.toFixed(2)}</div>
                        <div className="text-sm opacity-80">Wallet balance</div>
                        <div className="flex gap-2 mt-3">
                            <button
                                className="flex-1 py-2 font-bold btn-3d btn-red"
                                onClick={() => navigateTo('withdraw')}
                            >
                                Withdraw
                            </button>
                            <button
                                className="flex-1 py-2 font-bold btn-3d btn-green"
                                onClick={() => navigateTo('deposit')}
                            >
                                Deposit
                            </button>
                        </div>
                    </div>

                    <h2 className="text-2xl font-bold text-center mb-6 text-yellow-300">Select a Game</h2>

                    {/* Message Component */}
                    {showMessage && (
                        <div className="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-yellow-400 text-gray-900 px-6 py-4 rounded-lg shadow-lg z-50 text-center max-w-[90%]">
                            {messageText}
                        </div>
                    )}

                    <div className="grid grid-cols-1 gap-4 px-4 mb-20">
                        <div
                            className="card-3d p-6 flex flex-col items-center justify-center text-center cursor-pointer"
                            onClick={() => handleGameClick('colorPrediction')}
                        >
                            <img src="color.png" alt="Color Prediction Game Icon" className="w-24 h-24 rounded-full object-cover mb-4 border-2 border-yellow-400" onError={(e)=>{e.target.onerror = null; e.target.src='https://placehold.co/96x96/FFD700/000000?text=Color'}} />
                            <h3 className="text-xl font-bold mb-2 text-yellow-400">Color Prediction</h3>
                            <p className="text-sm opacity-80">Predict the next color and win!</p>
                        </div>

                        <div
                            className="card-3d p-6 flex flex-col items-center justify-center text-center cursor-pointer"
                            onClick={() => handleGameClick('mines')}
                        >
                            <img src="mine.png" alt="Mine Game Icon" className="w-24 h-24 rounded-full object-cover mb-4 border-2 border-yellow-400" onError={(e)=>{e.target.onerror = null; e.target.src='https://placehold.co/96x96/FFD700/000000?text=Mine'}} />
                            <h3 className="text-xl font-bold mb-2 text-yellow-400">Mine</h3>
                            <p className="text-sm opacity-80">Uncover treasures, avoid mines!</p>
                        </div>
                    </div>

                    {/* Share App Section */}
                    <div className="fixed bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-black to-transparent z-50">
                        <div className="max-w-md mx-auto">
                            <div className="flex gap-2">
                                {/* Share App Button - Full Width */}
                                <button
                                    onClick={() => {
                                        if (navigator.share) {
                                            navigator.share({
                                                title: 'BOLT999',
                                                text: 'Check out this amazing gaming app!',
                                                url: 'https://bolt999.wuaze.com',
                                            }).catch(console.error);
                                        } else {
                                            const dummy = document.createElement('input');
                                            document.body.appendChild(dummy);
                                            dummy.value = 'https://bolt999.wuaze.com';
                                            dummy.select();
                                            document.execCommand('copy');
                                            document.body.removeChild(dummy);
                                            alert('Link copied to clipboard! Share it with your friends.');
                                        }
                                    }}
                                    className="flex-1 py-3 font-bold btn-3d btn-green flex items-center justify-center gap-2"
                                >
                                    <span>Share App</span>
                                    <span className="text-xs opacity-80">https://bolt999.wuaze.com</span>
                                </button>
                                {/* Copy Button */}
                                <button
                                    onClick={() => {
                                        const dummy = document.createElement('input');
                                        document.body.appendChild(dummy);
                                        dummy.value = 'https://bolt999.wuaze.com';
                                        dummy.select();
                                        document.execCommand('copy');
                                        document.body.removeChild(dummy);
                                        
                                        // Show success message
                                        const message = document.createElement('div');
                                        message.className = 'fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 text-center';
                                        message.textContent = 'Link copied!';
                                        document.body.appendChild(message);
                                        setTimeout(() => document.body.removeChild(message), 2000);
                                    }}
                                    className="px-4 py-3 font-bold btn-3d btn-yellow text-black flex items-center justify-center"
                                    title="Copy Link"
                                >
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                        <rect width="14" height="14" x="8" y="8" rx="2" ry="2"/>
                                        <path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };


        // --- Admin Panel Component ---
        const AdminPanelPage = ({ users, deposits, withdrawals, updateUserBalance, updateDepositStatus, updateWithdrawalStatus, refreshAdminData, clearAllHistories, navigateTo, currentUser, isAdmin }) => {
            const [tab, setTab] = React.useState('users');
            const [loading, setLoading] = React.useState(false);
            const [message, setMessage] = React.useState(null);
            const [searchUser, setSearchUser] = React.useState('');
            React.useEffect(() => {
                if (!isAdmin) {
                    navigateTo('gameSelection');
                }
            }, [isAdmin]);
            const totalDeposits = deposits.filter(d=>d.status==='Completed').reduce((sum,d)=>sum+Number(d.amount||0),0);
            const totalWithdrawals = withdrawals.filter(w=>w.status==='Completed').reduce((sum,w)=>sum+Number(w.amount||0),0);
            const handleAdminAction = async (fn, successMsg) => {
                setLoading(true); setMessage(null);
                try { await fn(); setMessage({ type: 'success', text: successMsg }); refreshAdminData(); }
                catch (e) { setMessage({ type: 'error', text: e.message || 'Error' }); }
                setLoading(false);
            };
            return (
                <div className="min-h-screen bg-gradient-to-b from-black to-gray-900 text-white p-2 flex flex-col items-center">
                    <div className="w-full max-w-md mx-auto">
                        <div className="flex items-center gap-2 mb-4">
                            <button onClick={() => navigateTo('gameSelection')} className="p-2 rounded-full bg-gray-800 bg-opacity-50">
                                <ArrowLeft className="w-5 h-5 text-white" />
                            </button>
                            <h1 className="text-xl font-bold text-yellow-300">Admin Panel</h1>
                        </div>
                        <div className="flex gap-1 flex-wrap mb-4">
                            {['users','deposits','withdrawals','settings'].map(t => (
                                <button key={t} className={`px-2 py-1 rounded-lg font-semibold text-xs transition-colors ${tab===t?'bg-yellow-400 text-black shadow':'bg-gray-800 text-white hover:bg-yellow-500'}`} onClick={()=>setTab(t)}>{t.charAt(0).toUpperCase()+t.slice(1)}</button>
                            ))}
                        </div>
                        {message && <div className={`my-2 p-3 rounded text-center font-bold ${message.type==='success'?'bg-green-600 text-white':'bg-red-600 text-white'}`}>{message.text}</div>}
                        {loading && <div className="my-2 text-center text-yellow-300 animate-pulse">Processing...</div>}
                        {tab==='users' && (
                            <div className="mt-6 flex flex-col gap-3">
                                <h2 className="text-xl font-bold mb-2">Manage Users</h2>
                                <input
                                    type="text"
                                    placeholder="Search by Email or Phone..."
                                    className="mb-2 p-2 rounded bg-gray-800 text-white w-full text-xs"
                                    value={searchUser || ''}
                                    onChange={e => setSearchUser(e.target.value)}
                                />
                                {(users.filter(user => !searchUser || ((user.email && user.email.toLowerCase().includes(searchUser.toLowerCase())) || (user.phone && user.phone.includes(searchUser))))).map(user => (
                                    <div key={user.uid} className="bg-gray-900 rounded-lg p-3 shadow flex flex-col gap-2 mb-2">
                                        <div className="flex justify-between items-center">
                                            <span className="text-xs font-semibold break-all">{user.email || user.phone}</span>
                                            <span className="text-xs px-2 py-1 rounded bg-gray-800">Bal: ₹{user.balance}</span>
                                        </div>
                                        <div className="flex gap-2 items-center mt-1">
                                            <input type="number" className="w-20 p-1 rounded bg-gray-800 text-white text-xs" defaultValue={user.balance} onBlur={e=>handleAdminAction(()=>updateUserBalance(user.uid, parseFloat(e.target.value)), 'Balance updated!')} />
                                            <button onClick={()=>handleAdminAction(()=>window.toggleAdmin(user.uid, !user.isAdmin), user.isAdmin?'Admin removed!':'Admin added!')} className={`px-2 py-1 rounded text-xs ${user.isAdmin?'bg-yellow-400 text-black':'bg-gray-700 text-white hover:bg-yellow-500'}`}>{user.isAdmin?'Remove Admin':'Make Admin'}</button>
                                            <button onClick={()=>handleAdminAction(()=>window.deleteUser(user.uid), 'User deleted!')} className="px-2 py-1 rounded text-xs bg-red-600 text-white hover:bg-red-700">Delete</button>
                                        </div>
                                        <div className="text-center mt-1">{user.isAdmin ? <span className="bg-yellow-400 text-black px-2 py-1 rounded text-xs">Admin</span> : <span className="bg-gray-700 text-white px-2 py-1 rounded text-xs">User</span>}</div>
                                    </div>
                                ))}
                            </div>
                        )}
                        {tab==='deposits' && (
                            <div className="mt-6 flex flex-col gap-3">
                                <h2 className="text-xl font-bold mb-2">Manage Deposits</h2>
                                {(deposits.filter(dep => dep.status === 'Pending')).map((dep,i) => (
                                    <div key={i} className="bg-gray-900 rounded-lg p-3 shadow flex flex-col gap-2 mb-2">
                                        <div className="flex justify-between items-center">
                                            <span className="text-xs font-semibold break-all">{dep.upiId}</span>
                                            <span className="text-xs px-2 py-1 rounded bg-gray-800">₹{dep.amount}</span>
                                            <span className="text-xs px-2 py-1 rounded bg-gray-800">{dep.status}</span>
                                        </div>
                                        {dep.imageName && (
                                            <div className="flex justify-center mt-1"><img src={dep.imageUrl || ''} alt="screenshot" className="w-20 h-20 object-contain bg-white rounded" onError={e=>e.target.style.display='none'} /></div>
                                        )}
                                        <div className="flex gap-2 mt-2">
                                            <button onClick={()=>handleAdminAction(()=>window.approveDeposit(dep, i), 'Deposit approved!')} className="flex-1 px-2 py-1 bg-green-600 text-white rounded hover:bg-green-700 text-xs">Approve</button>
                                            <button onClick={()=>handleAdminAction(()=>window.rejectDeposit(dep, i), 'Deposit rejected!')} className="flex-1 px-2 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-xs">Reject</button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                        {tab==='withdrawals' && (
                            <div className="mt-6 flex flex-col gap-3">
                                <h2 className="text-xl font-bold mb-2">Manage Withdrawals</h2>
                                {(withdrawals.filter(w => w.status === 'Pending')).length === 0 ? (
                                    <p className="text-center opacity-70">No withdrawal requests yet.</p>
                                ) : (
                                    withdrawals.filter(w => w.status === 'Pending').map((w,i) => (
                                        <div key={i} className="bg-gray-900 rounded-lg p-3 shadow flex flex-col gap-2 mb-2">
                                            <div className="flex justify-between items-center">
                                                <span className="text-xs font-semibold break-all">{w.upiId}</span>
                                                <span className="text-xs px-2 py-1 rounded bg-gray-800">₹{w.amount}</span>
                                                <span className={`text-xs px-2 py-1 rounded bg-yellow-400 bg-opacity-20 text-yellow-800`}>{w.status || 'Pending'}</span>
                                            </div>
                                            <div className="flex gap-2 mt-2">
                                                <button onClick={()=>handleAdminAction(()=>window.approveWithdrawal(w, i), 'Withdrawal approved!')} className="flex-1 px-2 py-1 bg-green-600 text-white rounded hover:bg-green-700 text-xs">Approve</button>
                                                <button onClick={()=>handleAdminAction(()=>window.rejectWithdrawal(w, i), 'Withdrawal rejected!')} className="flex-1 px-2 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-xs">Reject</button>
                                            </div>
                                        </div>
                                    ))
                                )}
                            </div>
                        )}
                        {tab==='settings' && (
                            <div className="mt-6 flex flex-col items-center">
                                <h2 className="text-xl font-bold mb-2">Settings</h2>
                                <button onClick={()=>handleAdminAction(clearAllHistories, 'History cleared!')} className="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">Clear All History Data (Keep Balances, Last 10 Only)</button>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const App = () => {
            const [authenticated, setAuthenticated] = React.useState(false);
            const [currentPage, setCurrentPage] = React.useState('login');
            const [showInstallMessage, setShowInstallMessage] = React.useState(false);
            const [navigationHistory, setNavigationHistory] = React.useState(['login']);
            const [isAdmin, setIsAdmin] = React.useState(false);
            const [allUsers, setAllUsers] = React.useState([]);
            const [allDeposits, setAllDeposits] = React.useState([]);
            const [allWithdrawals, setAllWithdrawals] = React.useState([]);

            // Handle PWA installation
            React.useEffect(() => {
                window.addEventListener('beforeinstallprompt', (e) => {
                    e.preventDefault();
                    window.deferredPrompt = e;
                });

                window.addEventListener('appinstalled', () => {
                    setShowInstallMessage(true);
                    setTimeout(() => {
                        setShowInstallMessage(false);
                    }, 3000);
                });
            }, []);

            // Handle Android back button
            React.useEffect(() => {
                const handleBackButton = async (event) => {
                    if (navigationHistory.length > 1) {
                        event.preventDefault();
                        await showLoader(); // Show loader before navigation
                        const newHistory = [...navigationHistory];
                        newHistory.pop(); // Remove current page
                        const previousPage = newHistory[newHistory.length - 1];
                        setNavigationHistory(newHistory);
                        setCurrentPage(previousPage);
                    }
                };

                window.addEventListener('popstate', handleBackButton);
                return () => window.removeEventListener('popstate', handleBackButton);
            }, [navigationHistory]);

            const navigateTo = async (page) => {
                await showLoader();
                setCurrentPage(page);
                setNavigationHistory(prev => [...prev, page]);
                // Add to browser history
                window.history.pushState({ page }, '', `#${page}`);
            };

            const [historyInitialTab, setHistoryInitialTab] = React.useState('game');
            const [currentUser, setCurrentUser] = React.useState(null);
            const [balance, setBalance] = React.useState(0);
            const [gameHistory, setGameHistory] = React.useState([]);
            const [depositHistory, setDepositHistory] = React.useState([]);
            const [withdrawHistory, setWithdrawHistory] = React.useState([]);

            // Function to play transaction success sound
            const playTransactionSound = () => {
                const audio = new Audio('dw.mp3');
                audio.play().catch(error => console.log('Error playing audio:', error));
            };

            // Function to play error sound
            const playErrorSound = () => {
                const audio = new Audio('error.mp3');
                audio.play().catch(error => console.log('Error playing audio:', error));
            };

            // Listen for auth state changes
            React.useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged((user) => {
                    if (user) {
                        setCurrentUser(user);
                        setAuthenticated(true);
                        // Load user data from Firestore
                        loadUserData(user.uid, user.email);
                    } else {
                        setCurrentUser(null);
                        setAuthenticated(false);
                        setBalance(0);
                        setGameHistory([]);
                        setDepositHistory([]);
                        setWithdrawHistory([]);
                        setIsAdmin(false);
                    }
                });

                return () => unsubscribe();
            }, []);

            // Function to load user data from Firestore
            const loadUserData = async (userId, email) => {
                try {
                    const userDoc = await db.collection('users').doc(userId).get();
                    if (userDoc.exists) {
                        const userData = userDoc.data();
                        setBalance(userData.balance || 0);
                        setGameHistory(userData.gameHistory || []);
                        setDepositHistory(userData.depositHistory || []);
                        setWithdrawHistory(userData.withdrawHistory || []);
                        setIsAdmin(userData.isAdmin || email === 'moghaeashu@gmail.com');
                    }
                } catch (error) {
                    console.error("Error loading user data:", error);
                }
            };

            // Function to update user data in Firestore
            const updateUserData = async (updates) => {
                if (!currentUser) return;
                
                try {
                    await db.collection('users').doc(currentUser.uid).update(updates);
                } catch (error) {
                    console.error("Error updating user data:", error);
                }
            };

            // Update Firestore when balance changes
            React.useEffect(() => {
                if (currentUser) {
                    updateUserData({ balance });
                }
            }, [balance]);

            // Update Firestore when game history changes
            React.useEffect(() => {
                if (currentUser) {
                    updateUserData({ gameHistory });
                }
            }, [gameHistory]);

            // Update Firestore when deposit history changes
            React.useEffect(() => {
                if (currentUser) {
                    updateUserData({ depositHistory });
                }
            }, [depositHistory]);

            // Update Firestore when withdraw history changes
            React.useEffect(() => {
                if (currentUser) {
                    updateUserData({ withdrawHistory });
                }
            }, [withdrawHistory]);

            // Handlers for state updates from child components
            const addDepositToHistory = (deposit) => {
                setDepositHistory(prev => [deposit, ...prev]);
                playTransactionSound(); // Play sound on successful deposit
            };

            const addWithdrawToHistory = (withdraw) => {
                setWithdrawHistory(prev => [withdraw, ...prev]);
                playTransactionSound(); // Play sound on successful withdrawal
            };

            const handleDepositError = () => {
                playErrorSound(); // Play error sound on deposit mistakes
            };

            const handleWithdrawError = () => {
                playErrorSound(); // Play error sound on withdrawal mistakes
            };

            const handleLogout = async () => {
                try {
                    await showLoader();
                    await auth.signOut();
                    setCurrentUser(null);
                    setAuthenticated(false);
                } catch (error) {
                    console.error("Error signing out:", error);
                }
            };

            // Fetch all users, deposits, withdrawals for admin
            React.useEffect(() => {
                if (isAdmin) {
                    // Fetch users
                    db.collection('users').get().then(snapshot => {
                        const users = [];
                        snapshot.forEach(doc => users.push({ uid: doc.id, ...doc.data() }));
                        setAllUsers(users);
                    });
                    // Fetch deposits/withdrawals (simulate from all users)
                    db.collection('users').get().then(snapshot => {
                        let deposits = [], withdrawals = [];
                        snapshot.forEach(doc => {
                            const d = doc.data().depositHistory || [];
                            d.forEach(dep => { if (dep.status === 'Pending') deposits.push({ ...dep, user: doc.id }); });
                            const w = doc.data().withdrawHistory || [];
                            w.forEach(wd => { if (wd.status === 'Pending') withdrawals.push({ ...wd, user: doc.id }); });
                        });
                        setAllDeposits(deposits);
                        setAllWithdrawals(withdrawals);
                    });
                }
            }, [isAdmin]);

            // Admin actions
            const updateUserBalance = (uid, newBal) => {
                db.collection('users').doc(uid).update({ balance: newBal });
                setAllUsers(users => users.map(u => u.uid === uid ? { ...u, balance: newBal } : u));
            };
            // Update deposit status in Firestore
            const updateDepositStatus = (idx, status, dep) => {
                setAllDeposits(deps => deps.map((d,i) => i===idx ? { ...d, status } : d));
                // Find the user and update depositHistory
                db.collection('users').doc(dep.user).get().then(docSnap => {
                    if (!docSnap.exists) return;
                    const userData = docSnap.data();
                    const depositHistory = (userData.depositHistory || []).map(d => {
                        if (d.timestamp === dep.timestamp && d.amount === dep.amount) {
                            return { ...d, status };
                        }
                        return d;
                    });
                    db.collection('users').doc(dep.user).update({ depositHistory });
                });
            };
            // Update withdrawal status in Firestore
            const updateWithdrawalStatus = (idx, status, w) => {
                setAllWithdrawals(wds => wds.map((wd,i) => i===idx ? { ...wd, status } : wd));
                db.collection('users').doc(w.user).get().then(docSnap => {
                    if (!docSnap.exists) return;
                    const userData = docSnap.data();
                    const withdrawHistory = (userData.withdrawHistory || []).map(wd => {
                        if (wd.timestamp === w.timestamp && wd.amount === w.amount) {
                            return { ...wd, status };
                        }
                        return wd;
                    });
                    db.collection('users').doc(w.user).update({ withdrawHistory });
                });
            };

            // Admin helpers
            window.deleteUser = async (uid) => {
                if (!window.confirm('Are you sure you want to delete this user?')) return;
                await db.collection('users').doc(uid).delete();
                refreshAdminData();
            };
            window.toggleAdmin = async (uid, makeAdmin) => {
                await db.collection('users').doc(uid).update({ isAdmin: makeAdmin });
                refreshAdminData();
            };
            window.approveDeposit = async (dep, idx) => {
                const userRef = db.collection('users').doc(dep.user);
                const userDoc = await userRef.get();
                if (!userDoc.exists) return;
                const userData = userDoc.data();
                let depositHistory = (userData.depositHistory || []).map(d => {
                    if (d.timestamp === dep.timestamp && d.amount === dep.amount) {
                        return { ...d, status: 'Completed' };
                    }
                    return d;
                });
                depositHistory = depositHistory.slice(0, 10);
                const newBalance = (userData.balance || 0) + Number(dep.amount);
                await userRef.update({ depositHistory, balance: newBalance });
                // Remove from admin panel (pending list)
                window.removeDepositFromAdmin(idx);
                window.refreshAdminData();
            };
            window.rejectDeposit = async (dep, idx) => {
                const userRef = db.collection('users').doc(dep.user);
                const userDoc = await userRef.get();
                if (!userDoc.exists) return;
                const userData = userDoc.data();
                let depositHistory = (userData.depositHistory || []).map(d => {
                    if (d.timestamp === dep.timestamp && d.amount === dep.amount) {
                        return { ...d, status: 'Rejected' };
                    }
                    return d;
                });
                depositHistory = depositHistory.slice(0, 10);
                await userRef.update({ depositHistory });
                window.removeDepositFromAdmin(idx);
                window.refreshAdminData();
            };
            window.approveWithdrawal = async (w, idx) => {
                const userRef = db.collection('users').doc(w.user);
                const userDoc = await userRef.get();
                if (!userDoc.exists) return;
                const userData = userDoc.data();
                let withdrawHistory = (userData.withdrawHistory || []).map(wd => {
                    if (wd.timestamp === w.timestamp && wd.amount === w.amount) {
                        return { ...wd, status: 'Completed' };
                    }
                    return wd;
                });
                withdrawHistory = withdrawHistory.slice(0, 10);
                await userRef.update({ withdrawHistory });
                window.removeWithdrawalFromAdmin(idx);
                window.refreshAdminData();
            };
            window.rejectWithdrawal = async (w, idx) => {
                const userRef = db.collection('users').doc(w.user);
                const userDoc = await userRef.get();
                if (!userDoc.exists) return;
                const userData = userDoc.data();
                let withdrawHistory = (userData.withdrawHistory || []).map(wd => {
                    if (wd.timestamp === w.timestamp && wd.amount === w.amount) {
                        return { ...wd, status: 'Rejected' };
                    }
                    return wd;
                });
                withdrawHistory = withdrawHistory.slice(0, 10);
                await userRef.update({ withdrawHistory });
                window.removeWithdrawalFromAdmin(idx);
                window.refreshAdminData();
            };
            // Helper functions to remove from admin panel lists
            window.removeDepositFromAdmin = (idx) => {
                if (typeof idx === 'number' && window.setAllDeposits) {
                    window.setAllDeposits(deps => deps.filter((_, i) => i !== idx));
                }
            };
            window.removeWithdrawalFromAdmin = (idx) => {
                if (typeof idx === 'number' && window.setAllWithdrawals) {
                    window.setAllWithdrawals(wds => wds.filter((_, i) => i !== idx));
                }
            };
            // In App, expose setAllDeposits and setAllWithdrawals to window
            window.setAllDeposits = setAllDeposits;
            window.setAllWithdrawals = setAllWithdrawals;
            function refreshAdminData() {
                if (currentUser && currentUser.email === 'moghaeashu@gmail.com') {
                    db.collection('users').get().then(snapshot => {
                        const users = [];
                        snapshot.forEach(doc => users.push({ uid: doc.id, ...doc.data() }));
                        setAllUsers(users);
                    });
                    db.collection('users').get().then(snapshot => {
                        let deposits = [], withdrawals = [];
                        snapshot.forEach(doc => {
                            const d = doc.data().depositHistory || [];
                            d.forEach(dep => deposits.push({ ...dep, user: doc.id }));
                            const w = doc.data().withdrawHistory || [];
                            w.forEach(wd => withdrawals.push({ ...wd, user: doc.id }));
                        });
                        setAllDeposits(deposits);
                        setAllWithdrawals(withdrawals);
                    });
                }
            }
            window.refreshAdminData = refreshAdminData;
            window.clearAllHistories = async () => {
                if (!window.confirm('Are you sure you want to clear all history data for all users? This will keep only the last 10 deposit, withdrawal, and game history entries per user.')) return;
                const usersSnap = await db.collection('users').get();
                const batch = db.batch();
                usersSnap.forEach(doc => {
                    const userRef = db.collection('users').doc(doc.id);
                    const data = doc.data();
                    const depositHistory = (data.depositHistory || []).slice(0, 10);
                    const withdrawHistory = (data.withdrawHistory || []).slice(0, 10);
                    const gameHistory = (data.gameHistory || []).slice(0, 10);
                    batch.update(userRef, { depositHistory, withdrawHistory, gameHistory });
                });
                await batch.commit();
                window.refreshAdminData();
            };

            // In App, add auto-refresh for user and admin data
            // For user data (balance, history):
            React.useEffect(() => {
                if (!currentUser) return;
                const interval = setInterval(() => {
                    loadUserData(currentUser.uid, currentUser.email);
                }, 5000); // 5 seconds
                return () => clearInterval(interval);
            }, [currentUser]);
            // For admin data (users, deposits, withdrawals):
            React.useEffect(() => {
                if (isAdmin) {
                    const fetchAdminData = () => {
                        db.collection('users').get().then(snapshot => {
                            const users = [];
                            snapshot.forEach(doc => users.push({ uid: doc.id, ...doc.data() }));
                            setAllUsers(users);
                        });
                        db.collection('users').get().then(snapshot => {
                            let deposits = [], withdrawals = [];
                            snapshot.forEach(doc => {
                                const d = doc.data().depositHistory || [];
                                d.forEach(dep => { if (dep.status) deposits.push({ ...dep, user: doc.id }); });
                                const w = doc.data().withdrawHistory || [];
                                w.forEach(wd => { if (wd.status === 'Pending') withdrawals.push({ ...wd, user: doc.id }); });
                            });
                            setAllDeposits(deposits);
                            setAllWithdrawals(withdrawals);
                        });
                    };
                    fetchAdminData();
                    const interval = setInterval(fetchAdminData, 5000); // 5 seconds
                    return () => clearInterval(interval);
                }
            }, [isAdmin]);

            if (!authenticated) {
                if (currentPage === 'login') {
                    return <LoginPage setAuthenticated={setAuthenticated} navigateToRegister={() => navigateTo('register')} />;
                } else {
                    return <RegisterPage setAuthenticated={setAuthenticated} navigateToLogin={() => navigateTo('login')} />;
                }
            }

            return (
                <>
                    {(() => {
                        switch (currentPage) {
                            case 'gameSelection':
                                return <GameSelectionPage balance={balance} navigateTo={navigateTo} handleLogout={handleLogout} isAdmin={isAdmin} currentUser={currentUser} />;
                            case 'colorPrediction':
                                return <ColorPredictionGame
                                    balance={balance}
                                    setBalance={setBalance}
                                    navigateTo={navigateTo}
                                    gameHistory={gameHistory}
                                    setGameHistory={setGameHistory}
                                    addDepositToHistory={addDepositToHistory}
                                    addWithdrawToHistory={addWithdrawToHistory}
                                    currentUser={currentUser}
                                    updateUserData={updateUserData}
                                />;
                            case 'deposit':
                                return <DepositPage 
                                    setBalance={setBalance} 
                                    navigateTo={navigateTo} 
                                    addDepositToHistory={addDepositToHistory}
                                    onError={handleDepositError}
                                />;
                            case 'withdraw':
                                return <WithdrawPage 
                                    balance={balance} 
                                    setBalance={setBalance} 
                                    navigateTo={navigateTo} 
                                    addWithdrawToHistory={addWithdrawToHistory}
                                    onError={handleWithdrawError}
                                />;
                            case 'history':
                                return <HistoryPage navigateTo={navigateTo} gameHistory={gameHistory} depositHistory={depositHistory} withdrawHistory={withdrawHistory} initialTab={historyInitialTab} />;
                            case 'mines':
                                return <MinesGame balance={balance} setBalance={setBalance} navigateTo={navigateTo} />;
                            case 'admin':
                                return <AdminPanelPage
                                    users={allUsers}
                                    deposits={allDeposits}
                                    withdrawals={allWithdrawals}
                                    updateUserBalance={updateUserBalance}
                                    updateDepositStatus={updateDepositStatus}
                                    updateWithdrawalStatus={updateWithdrawalStatus}
                                    refreshAdminData={window.refreshAdminData}
                                    clearAllHistories={window.clearAllHistories}
                                    navigateTo={navigateTo}
                                    currentUser={currentUser}
                                    isAdmin={isAdmin}
                                />;
                            default:
                                return <GameSelectionPage balance={balance} navigateTo={navigateTo} handleLogout={handleLogout} isAdmin={isAdmin} currentUser={currentUser} />;
                        }
                    })()}
                </>
            );
        };

        // Loader Component
        const Loader = () => (
            <div className="loader-container">
                <div className="loader-content">
                    <div className="loader-glow"></div>
                    <div className="loader-ring"></div>
                    <div className="loader-logo">
                        <img src="logo.avif" alt="Loading..." />
                    </div>
                </div>
            </div>
        );

        // Function to show loader for 2 seconds
        const showLoader = () => {
            return new Promise((resolve) => {
                const loaderRoot = document.createElement('div');
                loaderRoot.id = 'loader-root';
                document.body.appendChild(loaderRoot);
                
                ReactDOM.render(<Loader />, loaderRoot);
                
                setTimeout(() => {
                    ReactDOM.unmountComponentAtNode(loaderRoot);
                    document.body.removeChild(loaderRoot);
                    resolve();
                }, 2000);
            });
        };

        // Preloader function
        const showPreloader = async () => {
            const loaderRoot = document.createElement('div');
            loaderRoot.id = 'loader-root';
            document.body.appendChild(loaderRoot);
            
            ReactDOM.render(<Loader />, loaderRoot);
            
            // Wait for 2 seconds
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // Remove loader
            ReactDOM.unmountComponentAtNode(loaderRoot);
            document.body.removeChild(loaderRoot);
            
            // Render the main app
            ReactDOM.render(<App />, document.getElementById('root'));
        };

        // Start the app with preloader
        showPreloader();
    </script>
</body>
</html>
